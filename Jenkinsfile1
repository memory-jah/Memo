pipeline {
    agent {
        docker { 
            image 'httpd'
            args '-u root' }
    }

    options {
        timeout(time: 10, unit: 'MINUTES') // Timeout for the entire pipeline
        buildDiscarder(logRotator(numToKeepStr: '5')) // Discard old builds to save disk space
        disableConcurrentBuilds() // Ensures that only one build can run at a time
        timestamps() // Adds timestamps to the console output
        skipDefaultCheckout() // Skips the default checkout of source code, useful if you're doing a custom checkout
        // retry(3) // Automatically retries the entire pipeline up to 3 times if it fails
    }

    parameters {
        string(name: 'BRANCH_NAME', defaultValue: 'main', description: '')
        choice(name: 'APP', choices: ['', 'covid19', 'articles', 'halloween'], description: 'Select the app that you want to download')
        booleanParam(name: 'INSTALL_APACHE', defaultValue: false, description: 'Install Apache')
    }

    stages {
        stage('Clone Repository') {
            steps {
                script {
                    git credentialsId: 'personal-git',
                        url: 'https://github.com/Demefo/Terraform.git',
                        branch: "${params.BRANCH_NAME}"
                }
            }
        }

        stage('Install Apache and Tools') {
            when {
                expression { return params.INSTALL_APACHE }
            }
            steps {
                sh '''
                apt-get update
                '''
            }
        }

        stage('Deploy') {
            steps {
                echo "Selected APP: ${params.APP}"
                script {
                    if (params.APP == 'covid19') {
                        sh '''
                        ls -la terraform/AWS/ec2
                        wget https://linux-devops-course.s3.amazonaws.com/WEB+SIDE+HTML/covid19.zip
                        unzip -o covid19.zip
                        sudo rm -rf /usr/local/apache2/htdocs*
                        sudo cp -r covid19/* /usr/local/apache2/htdocs*
                        rm -rf covide19*
                        '''
                    } 
                    else if (params.APP == 'articles') {
                        sh '''
                        ls -la terraform/AWS/eip/
                        wget https://linux-devops-course.s3.amazonaws.com/articles.zip
                        unzip -o articles.zip
                        sudo rm -rf /usr/local/apache2/htdocs*
                        sudo cp -r articles/* /usr/local/apache2/htdocs*
                        '''
                    } 
                    else if (params.APP == 'halloween') {
                        sh '''
                        ls -lh 
                        wget https://linux-devops-course.s3.amazonaws.com/halloween.zip
                        unzip -o halloween.zip
                        sudo rm -rf /usr/local/apache2/htdocs*
                        sudo cp -r halloween/* /usr/local/apache2/htdocs*
                        '''
                    } 
                    else {
                        error 'Unknown APP selected'
                    }
                }
            }
        }
    }
}
